<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gubby House — Full Game (P2P + Firestore Admin)</title>

<!--
  Firestore Rules (paste into Firebase Console -> Firestore -> Rules)
  -----------------------------------------------------------------
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /users/{userId} {
        allow create: if request.auth != null && request.auth.uid == userId;
        allow read: if request.auth != null && request.auth.uid == userId;
        allow update: if request.auth != null && (
          (request.auth.uid == userId && !("privileges" in request.resource.data))
          || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.privileges == 'admin')
        );
      }
      match /variants/{variantId} {
        allow read: if true;
        allow create, update, delete: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.privileges == 'admin';
      }
      match /shop/{shopId} {
        allow read: if true;
        allow create, update, delete: if request.auth != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.privileges == 'admin';
      }
      match /rooms/{roomId} {
        allow read: if true;
        allow create, update: if request.auth != null;
      }
      match /{document=**} { allow read, write: if false; }
    }
  }
  Notes:
  - Users doc must be created at /users/{uid} with privileges:'normal' by default.
  - Admins set 'privileges' to 'admin' via console for admin access.
-->

<style>
:root{--bg:#f3f7fb;--card:#fff;--accent:#6b8cff}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Arial}
body{margin:0;min-height:100vh;background:linear-gradient(#e6f3ff,#f7fbff);display:flex;align-items:center;justify-content:center;padding:18px}
.app{width:100%;max-width:1200px;background:var(--card);border-radius:12px;box-shadow:0 14px 40px rgba(10,10,30,0.12);overflow:hidden}
header{display:flex;align-items:center;gap:12px;padding:12px 18px;border-bottom:1px solid #eef3ff}
header h1{margin:0;font-size:18px}
.main{display:grid;grid-template-columns:560px 1fr;gap:12px;padding:18px}
.left{background:#f8fbff;border-radius:10px;padding:12px}
.right{padding:12px}
.house{width:520px;height:420px;background-image:linear-gradient(#fff,#def);border-radius:8px;position:relative;overflow:hidden;border:2px solid #e6f2ff}
.gubby-sprite{position:absolute;transform:translate(-50%,-50%);width:96px;height:96px;transition:left .5s linear, top .5s linear, transform .2s}
.hud{display:flex;gap:8px;margin-top:8px}
.stat{background:white;padding:8px;border-radius:8px;border:1px solid #eef4ff;flex:1}
.stat strong{display:block}
.controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
button{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:white;font-weight:600;cursor:pointer}
button.secondary{background:#eef3ff;color:#164ea6}
.panel{background:#fff;padding:10px;border-radius:8px;border:1px solid #eef4ff;margin-bottom:12px}
label{font-size:13px;color:#444}
input[type=text], input[type=password], input[type=number], select, textarea{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #e6eef9}
.small{font-size:12px;color:#667}
.variants-list{display:flex;gap:8px;flex-wrap:wrap}
.variant-pill{padding:6px 8px;border-radius:8px;border:1px solid #e6eef9;background:white;cursor:pointer}
.admin-panel{display:none;border-top:1px dashed #e6eef9;padding-top:8px;margin-top:8px}
.visible{display:block}
.muted{color:#667;font-size:13px}
.row{display:flex;gap:8px;align-items:center}
footer{padding:12px;border-top:1px solid #f0f6ff;text-align:center;font-size:12px;color:#666}
textarea{min-height:72px; font-family:monospace; white-space:pre-wrap}
.notice{background:#fffbeb;border:1px solid #ffecb5;padding:8px;border-radius:8px}
</style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>Gubby House — P2P + Firestore Admin</h1>
      <div style="margin-left:auto" id="authArea" class="muted small">Not signed in</div>
    </header>

    <div class="main">
      <div class="left">
        <div class="house" id="house">
          <img id="gubbySprite" class="gubby-sprite" src="../sprites/variants/default.png" style="left:50%;top:60%" draggable="false" />
        </div>

        <div class="hud">
          <div class="stat"><strong>Hunger <span id="hungerVal">0</span>%</strong><div class="small" id="hungerBar">—</div></div>
          <div class="stat"><strong>Thirst <span id="thirstVal">0</span>%</strong><div class="small" id="thirstBar">—</div></div>
          <div class="stat"><strong>Energy <span id="energyVal">0</span>%</strong><div class="small" id="energyBar">—</div></div>
        </div>

        <div class="controls">
          <button id="feedBtn">Feed</button>
          <button id="waterBtn" class="secondary">Give Water</button>
          <button id="colaBtn">Give Bloxy Cola</button>
          <button id="playBtn" class="secondary">Play</button>
          <button id="showInvite" class="secondary">Create Invite (host)</button>
          <button id="pasteInvite" class="secondary">Paste Invite (join)</button>
          <div style="margin-left:auto" class="small muted">P2P: manual copy/paste for serverless signaling</div>
        </div>

        <div style="margin-top:12px" class="panel">
          <label>Connection & Messages</label>
          <div class="row" style="gap:6px;align-items:flex-start">
            <textarea id="inviteOut" placeholder="Invite / Answer will appear here (copy & send to friend)"></textarea>
            <textarea id="inviteIn" placeholder="Paste friend's invite/answer here then press 'Process Invite'"></textarea>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button id="processInvite">Process Invite</button>
              <button id="disconnectBtn" class="secondary">Disconnect</button>
            </div>
          </div>
          <div style="margin-top:8px" class="muted small">How to connect (no server): Host: Create Invite → send the invite string to friend.
            Friend: Paste that invite → press "Process Invite" → send the Answer back to host → Host pastes Answer and presses Process Invite to complete the handshake.</div>
        </div>

      </div>

      <div class="right">
        <div class="panel">
          <label>Account / Login</label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="googleSignIn" class="secondary">Sign in with Google</button>
            <button id="guestBtn">Play as Guest</button>
          </div>
          <div id="accountInfo" class="muted small" style="margin-top:8px">—</div>
        </div>

        <div class="panel">
          <label>Shop & Upgrades</label>
          <div id="shopList" style="margin-top:8px"></div>
        </div>

        <div class="panel">
          <label>Variants</label>
          <div class="variants-list" id="variantsList"></div>
        </div>

        <div class="panel admin-panel" id="adminPanel">
          <label>Admin Panel — Create Variant / Shop Item (Firestore)</label>
          <div style="margin-top:8px">
            <label>Variant ID</label>
            <input type="text" id="variantId" placeholder="e.g. LavaGubby" />
            <label style="margin-top:6px">File name (inside ../sprites/variants/)</label>
            <input type="text" id="variantFile" placeholder="e.g. lava.png" />
            <label style="margin-top:6px">Price (clicks)</label>
            <input type="number" id="variantPrice" value="500" />
            <label style="margin-top:6px">Attributes (json) — e.g. {"clickMultiplier":2,"energyBonus":10}</label>
            <input type="text" id="variantAttrs" placeholder='{"clickMultiplier":2,"energyBonus":10}' />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="createVariantBtn">Create Variant in Firestore</button>
              <button id="refreshVariants" class="secondary">Refresh</button>
            </div>
            <div class="muted small" style="margin-top:8px">Admin-only: creating a variant will add a shop upgrade in Firestore. Ensure the file exists under ../sprites/variants/ in your hosted repo.</div>
          </div>
        </div>

      </div>
    </div>
    <footer>Standalone P2P + Firestore admin UI. Sprites base path = <code>../sprites/variants/</code></footer>
  </div>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ====== CONFIG ======
   Make sure this matches your Firebase project.
   (You provided this earlier; keep it or replace with your own.)
*/
const firebaseConfig = {
  apiKey: "AIzaSyAai5V9VTtPnAdMoAhhVe94fobPOY25yf8",
  authDomain: "gubby-clicker.firebaseapp.com",
  projectId: "gubby-clicker",
  storageBucket: "gubby-clicker.firebasestorage.app",
  messagingSenderId: "255072290621",
  appId: "1:255072290621:web:9f80676beac50c0059a754",
  measurementId: "G-R3HFMPH5C4"
};

/* FIX: sprite base path (relative to page).
   Use ../sprites/variants/ so hosted path like:
   https://beston3000.github.io/gubbyclicker/sprites/variants/default.png
*/
const SPRITE_BASE_PATH = "../sprites/variants/";

/* ====== App State & UI Helpers ====== */
function el(id){ return document.getElementById(id); }

const defaultState = {
  name: 'Gubby',
  variant: 'default.png',
  pos:{x:260,y:210},
  hunger:80, thirst:80, energy:100, alive:true,
  clicks:0, totalClicks:0,
  upgrades:{clickPower:1, autoClicks:0, multipliers:[]}
};
let state = loadState();
let user = null;
let db = null;
let auth = null;

/* UI refs */
const gubbySprite = el('gubbySprite');
const hungerVal = el('hungerVal'), thirstVal = el('thirstVal'), energyVal = el('energyVal');
const feedBtn = el('feedBtn'), waterBtn = el('waterBtn'), colaBtn = el('colaBtn'), playBtn = el('playBtn');
const shopList = el('shopList'), variantsList = el('variantsList');
const adminPanel = el('adminPanel');
const authArea = el('authArea');
const accountInfo = el('accountInfo');

/* Local variants fallback */
let localVariants = [
  {id:'Default', fileName:'default.png', price:0, attributes:{}},
  {id:'Water', fileName:'water.png', price:100, attributes:{clickMultiplier:1.2}},
  {id:'Lava', fileName:'lava.png', price:500, attributes:{clickMultiplier:1.5, energyBonus:10}}
];

/* Initialize UI */
applyStateToUI();
renderShop();
renderVariantsClientSide();

/* Button wiring */
el('guestBtn').addEventListener('click', ()=>{ user = {uid:'guest_'+randomId(), displayName:'Guest'}; onSignedIn(); });
el('googleSignIn').addEventListener('click', ()=>{ if(!auth) initFirebaseAndAuth(); signInWithGoogle(); });
el('feedBtn').addEventListener('click', ()=>{ if(!state.alive) return; state.hunger = Math.min(100,state.hunger+25); syncLocalAndPeers(); });
el('waterBtn').addEventListener('click', ()=>{ if(!state.alive) return; state.thirst = Math.min(100,state.thirst+25); syncLocalAndPeers(); });
el('colaBtn').addEventListener('click', ()=>{ if(!state.alive) return; state.energy = Math.min(100,state.energy+50); syncLocalAndPeers(); });
el('playBtn').addEventListener('click', ()=>{ if(!state.alive) return; state.energy = Math.min(100,state.energy+10); addClicks(5); syncLocalAndPeers(); });

el('showInvite').addEventListener('click', ()=>{ if(pc) return alert('Already initialized, disconnect first'); startHostInvite(); });
el('pasteInvite').addEventListener('click', ()=>{ const s=prompt('Paste invite/answer JSON string here'); if(s) processInviteString(s.trim()); });
el('processInvite').addEventListener('click', ()=>{ const s = el('inviteIn').value.trim(); if(!s) return alert('Paste invite/answer first'); processInviteString(s); });
el('disconnectBtn').addEventListener('click', disconnectPeer);

el('createVariantBtn').addEventListener('click', async ()=>{
  if(!db || !user) return alert('Sign-in and enable Firestore to create variants in DB.');
  const id = el('variantId').value.trim(); const file = el('variantFile').value.trim(); const price = Number(el('variantPrice').value)||0;
  let attrs={}; try{ attrs = JSON.parse(el('variantAttrs').value || '{}'); }catch(e){ return alert('Invalid JSON in attributes'); }
  if(!id||!file) return alert('Provide id and file name');
  // Quick validation: try to HEAD the sprite path (best-effort)
  try{
    const res = await fetch(SPRITE_BASE_PATH + file, {method:'HEAD'});
    if(!res.ok && !confirm('Sprite not found at '+SPRITE_BASE_PATH+file+'. Create anyway?')) return;
  }catch(e){ if(!confirm('Could not verify sprite file, continue anyway?')) return; }
  // create firestore docs
  try{
    const variantsRef = db.collection('variants');
    const shopRef = db.collection('shop');
    await variantsRef.add({ id, fileName:file, price, attributes:attrs, createdBy:user.uid, createdAt: Date.now() });
    await shopRef.add({ type:'variant', variantFile:file, variantId:id, price, attributes:attrs, createdBy:user.uid, createdAt: Date.now() });
    alert('Variant and shop item created in Firestore.');
  }catch(e){ alert('Firestore error: '+e.message); console.error(e); }
});

/* ====== Firebase init, auth & Firestore interaction ====== */
function initFirebaseAndAuth(){
  if(window.firebase && !auth){
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    // auth state observer
    auth.onAuthStateChanged(async u => {
      if(u){
        user = u;
        // ensure user doc exists
        try{
          const userRef = db.collection('users').doc(u.uid);
          const doc = await userRef.get();
          if(!doc.exists){
            await userRef.set({ displayName: u.displayName || u.email.split('@')[0], email: u.email, privileges: 'normal', createdAt: Date.now() });
          }
          const profile = (await userRef.get()).data();
          onSignedIn(profile);
        }catch(e){ console.error('users doc error', e); onSignedIn(); }
      } else {
        user = null;
        authArea.textContent = 'Not signed in';
        accountInfo.textContent = '—';
        adminPanel.classList.remove('visible');
      }
    });

    // listen to variants & shop in firestore
    db.collection('variants').onSnapshot(snap => {
      const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderVariantsFromFirestore(items);
    });
    db.collection('shop').onSnapshot(snap => {
      const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderShopFromFirestore(items);
    });
  }
}

async function signInWithGoogle(){
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
    // onAuthStateChanged will handle post-login
  }catch(e){ alert('Sign-in failed: '+e.message); }
}

async function onSignedIn(profile){
  // user var might be auth user object or guest stub
  authArea.textContent = `Signed in: ${user.displayName || user.name || user.email || 'User'}`;
  accountInfo.textContent = user.email ? `Email: ${user.email}` : `ID: ${user.uid}`;
  // check privileges from /users/{uid} if available
  if(db && user && user.uid){
    try{
      const doc = await db.collection('users').doc(user.uid).get();
      if(doc.exists){
        const data = doc.data();
        if(data.privileges === 'admin'){
          adminPanel.classList.add('visible');
        } else adminPanel.classList.remove('visible');
        accountInfo.textContent += ` — privileges: ${data.privileges || 'normal'}`;
      } else {
        accountInfo.textContent += ' — users doc not found (created on signup)';
      }
    }catch(e){ console.error('priv check failed', e); }
  }
  applyStateToUI();
  renderShop();
  renderVariantsClientSide();
}

/* ======= Shop & Variants rendering ======= */
function renderShop(){
  shopList.innerHTML = '';
  const builtins = [
    {title:'Upgrade Click Power', price:100, action:()=>{ if(state.totalClicks < 100) return alert('Not enough clicks'); state.upgrades.clickPower += 1; state.totalClicks -= 100; syncLocalAndPeers(); }},
    {title:'Auto Clicker', price:500, action:()=>{ if(state.totalClicks < 500) return alert('Not enough clicks'); state.upgrades.autoClicks += 1; state.totalClicks -= 500; syncLocalAndPeers(); }},
    {title:'Multiplier x1.5', price:1500, action:()=>{ if(state.totalClicks < 1500) return alert('Not enough clicks'); state.upgrades.multipliers.push(1.5); state.totalClicks -= 1500; syncLocalAndPeers(); }}
  ];
  const all = builtins.concat(localVariants);
  all.forEach(item=>{
    const name = item.title || item.id || item.fileName;
    const price = item.price || item.price || 100;
    const div = document.createElement('div'); div.className='row'; div.style.justifyContent='space-between';
    div.innerHTML = `<div><strong>${name}</strong><div class="small">Price: ${price} clicks</div></div><div><button>Buy</button></div>`;
    div.querySelector('button').addEventListener('click', ()=>{
      if(state.totalClicks < price) return alert('Not enough clicks');
      state.totalClicks = Math.max(0, state.totalClicks - price);
      if(item.fileName){ state.variant = item.fileName; if(item.attributes){ if(item.attributes.clickMultiplier) state.upgrades.multipliers.push(item.attributes.clickMultiplier); if(item.attributes.autoClicks) state.upgrades.autoClicks = (state.upgrades.autoClicks||0) + item.attributes.autoClicks; if(item.attributes.clickPower) state.upgrades.clickPower = (state.upgrades.clickPower||1) + item.attributes.clickPower; } }
      if(item.action) item.action();
      syncLocalAndPeers();
    });
    shopList.appendChild(div);
  });
}

function renderShopFromFirestore(items){
  shopList.innerHTML = '';
  items.forEach(doc=>{
    const name = doc.type || doc.title || doc.variantId || 'Shop Item';
    const price = doc.price || 0;
    const div = document.createElement('div'); div.className='row'; div.style.justifyContent='space-between';
    div.innerHTML = `<div><strong>${name}</strong><div class="small">Price: ${price}</div></div><div><button>Buy</button></div>`;
    div.querySelector('button').addEventListener('click', ()=>{
      if(state.totalClicks < price) return alert('Not enough clicks');
      state.totalClicks = Math.max(0, state.totalClicks - price);
      if(doc.type === 'variant'){ state.variant = doc.variantFile; }
      if(doc.attributes){
        if(doc.attributes.clickMultiplier) state.upgrades.multipliers.push(doc.attributes.clickMultiplier);
        if(doc.attributes.autoClicks) state.upgrades.autoClicks = (state.upgrades.autoClicks||0) + doc.attributes.autoClicks;
        if(doc.attributes.clickPower) state.upgrades.clickPower = (state.upgrades.clickPower||1) + doc.attributes.clickPower;
      }
      syncLocalAndPeers();
      alert('Purchased');
    });
    shopList.appendChild(div);
  });
}

function renderVariantsClientSide(){
  variantsList.innerHTML='';
  localVariants.forEach(v => {
    const pill = document.createElement('div'); pill.className='variant-pill'; pill.textContent = `${v.fileName}${v.price? ' — '+v.price:''}`;
    pill.addEventListener('click', ()=>{ state.variant = v.fileName; syncLocalAndPeers(); });
    variantsList.appendChild(pill);
  });
}

function renderVariantsFromFirestore(items){
  variantsList.innerHTML='';
  items.forEach(v=>{
    const pill = document.createElement('div'); pill.className='variant-pill';
    pill.textContent = `${v.fileName}${v.price? ' — '+v.price:''}`;
    pill.addEventListener('click', ()=>{ state.variant = v.fileName; syncLocalAndPeers(); });
    variantsList.appendChild(pill);
  });
}

/* ======= State apply/save/load ======= */
function applyStateToUI(){
  hungerVal.textContent = Math.round(state.hunger);
  thirstVal.textContent = Math.round(state.thirst);
  energyVal.textContent = Math.round(state.energy);
  gubbySprite.src = SPRITE_BASE_PATH + state.variant;
  // small top-right info
  authArea.textContent = user ? (`User: ${user.displayName || user.name || (user.email||user.uid)}`) : 'Not signed in';
}
function saveState(){ localStorage.setItem('gubby_full_v1', JSON.stringify(state)); }
function loadState(){ try{ const raw=localStorage.getItem('gubby_full_v1'); if(raw) return JSON.parse(raw);}catch(e){} return JSON.parse(JSON.stringify(defaultState)); }
function addClicks(n){ state.clicks += n; state.totalClicks += n; saveState(); applyStateToUI(); }
function getMultiplier(){ let m=1; if(state.upgrades.multipliers) state.upgrades.multipliers.forEach(v=>m*=v); return m; }

/* ======= Movement, decay, autos ======= */
const houseRect = {w:520,h:420};
function wander(){ if(!state.alive) return; const margin=48; const x=Math.random()*(houseRect.w-margin*2)+margin; const y=Math.random()*(houseRect.h-margin*2)+margin; state.pos.x=x; state.pos.y=y; gubbySprite.style.left = x+'px'; gubbySprite.style.top = y+'px'; }
setInterval(wander, 3000);

setInterval(()=>{
  if(!state.alive) return;
  state.hunger = Math.max(0, state.hunger - 1);
  state.thirst = Math.max(0, state.thirst - 1.2);
  const hour = (new Date()).getHours();
  if(hour>=22 || hour<7) state.energy = Math.min(100, state.energy + 2); else state.energy = Math.max(0, state.energy - 0.5);
  if(state.hunger===0 || state.thirst===0) state.energy = Math.max(0, state.energy - 2);
  if(state.energy===0){ state.alive=false; gubbySprite.src = SPRITE_BASE_PATH + 'dead.png'; }
  if(state.upgrades.autoClicks>0 && state.alive) addClicks(state.upgrades.autoClicks);
  syncLocalAndPeers();
}, 10000);

gubbySprite.addEventListener('click', ()=>{
  if(!state.alive) return;
  const power = state.upgrades.clickPower * getMultiplier();
  addClicks(power);
  state.energy = Math.max(0, state.energy - 1);
  state.hunger = Math.max(0, state.hunger - 0.5);
  state.thirst = Math.max(0, state.thirst - 0.7);
  syncLocalAndPeers();
});

/* ======= P2P (manual WebRTC signaling) ======= */
let pc = null, dc = null, isHost = false, lastOfferId = null;

function startHostInvite(){
  isHost = true; lastOfferId = randomId(); preparePeerConnection();
  dc = pc.createDataChannel('gubby'); setupDataChannel(dc);
  pc.createOffer().then(offer => pc.setLocalDescription(offer)).then(()=> {
    // once setLocalDescription available, produce invite
    const invite = { type:'offer', sdp: pc.localDescription.sdp, id:lastOfferId, from: user?.uid || 'guest', name: user?.displayName || 'Guest' };
    el('inviteOut').value = btoa(JSON.stringify(invite));
    alert('Invite created; copy the invite string and send to your friend.');
  }).catch(err=>{ console.error(err); alert('Offer failed: '+err.message); });
}

function preparePeerConnection(){
  const config = { iceServers: [{urls:['stun:stun.l.google.com:19302']}] };
  pc = new RTCPeerConnection(config);
  pc.onicecandidate = ()=> {
    if(pc.iceGatheringState === 'complete'){
      const full = { type:'offer', sdp: pc.localDescription.sdp, id:lastOfferId, from:user?.uid || 'guest', name:user?.displayName || 'Guest' };
      el('inviteOut').value = btoa(JSON.stringify(full));
    }
  };
  pc.ondatachannel = (ev)=> { dc = ev.channel; setupDataChannel(dc); };
  pc.onconnectionstatechange = ()=> {
    if(pc.connectionState === 'connected'){ showStatus('Peer connected'); sendMessage({t:'stateSync', state}); }
  };
}

function setupDataChannel(channel){
  channel.onopen = ()=> showStatus('Data channel open');
  channel.onmessage = (ev)=> { try{ const msg = JSON.parse(ev.data); handlePeerMessage(msg); }catch(e){ console.log('raw', ev.data); } };
  channel.onclose = ()=> showStatus('Data channel closed');
}

function handlePeerMessage(msg){
  if(msg.t==='stateSync') mergeRemoteState(msg.state);
  if(msg.t==='action') applyRemoteAction(msg.action);
  if(msg.t==='ping') sendMessage({t:'pong'});
}

function mergeRemoteState(remote){
  if(!remote) return;
  if(remote.totalClicks > state.totalClicks){
    state.totalClicks = remote.totalClicks;
    state.upgrades = remote.upgrades || state.upgrades;
    state.variant = remote.variant || state.variant;
  }
  state.hunger = Math.max(0, Math.min(100, Math.round((state.hunger + (remote.hunger||state.hunger))/2)));
  state.thirst = Math.max(0, Math.min(100, Math.round((state.thirst + (remote.thirst||state.thirst))/2)));
  state.energy = Math.max(0, Math.min(100, Math.round((state.energy + (remote.energy||state.energy))/2)));
  saveState(); applyStateToUI();
}

function applyRemoteAction(action){
  if(!action) return;
  if(action.type==='click') addClicks(action.value||1);
  if(action.type==='feed') state.hunger = Math.min(100, state.hunger + (action.value||20));
  if(action.type==='water') state.thirst = Math.min(100, state.thirst + (action.value||20));
  if(action.type==='cola') state.energy = Math.min(100, state.energy + (action.value||40));
  saveState(); applyStateToUI();
}

async function processInviteString(b64str){
  let obj=null;
  try{ obj=JSON.parse(atob(b64str)); }catch(e){ return alert('Invalid invite format'); }
  if(obj.type==='offer'){
    isHost=false; lastOfferId = obj.id; preparePeerConnection();
    await pc.setRemoteDescription({type:'offer', sdp: obj.sdp});
    const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
    const answerObj = { type:'answer', sdp: pc.localDescription.sdp, id: obj.id, from: user?.uid || 'guest', name: user?.displayName || 'Guest' };
    el('inviteOut').value = btoa(JSON.stringify(answerObj));
    alert('Answer created; send this answer back to the host.');
  } else if(obj.type==='answer'){
    if(!pc) return alert('No offer exists here — host must create invite first.');
    await pc.setRemoteDescription({type:'answer', sdp: obj.sdp});
    alert('Answer processed; connection should establish if NAT permits.');
  } else alert('Unknown invite type: '+obj.type);
}

function sendMessage(msg){ if(dc && dc.readyState==='open') dc.send(JSON.stringify(msg)); }
function syncLocalAndPeers(){ saveState(); applyStateToUI(); if(dc && dc.readyState==='open') sendMessage({t:'stateSync', state}); }
function disconnectPeer(){ try{ if(dc) dc.close(); }catch(e){} try{ if(pc) pc.close(); }catch(e){} pc=null; dc=null; isHost=false; lastOfferId=null; el('inviteOut').value=''; el('inviteIn').value=''; showStatus('Disconnected'); }
function showStatus(msg){ console.log('[status]', msg); accountInfo.textContent = user ? (user.displayName||user.email||user.uid) + ' — ' + msg : 'guest — '+msg; }

/* ======= Utilities ======= */
function randomId(){ return Math.random().toString(36).slice(2,9); }

/* Expose for debugging */
window.gubbyGame = { state, saveState, loadState, syncLocalAndPeers, startHostInvite, processInviteString, disconnectPeer };

/* Initialize Firebase only when needed so offline guests still work */
(function tryAutoInit(){
  // if user hits Sign in with Google, initFirebaseAndAuth() will be called
})();

</script>
</body>
</html>
