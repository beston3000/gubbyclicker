<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raise a Gubby</title>
    <!-- 
    A NOTE ON FIRESTORE RULES
    These rules are essential for security and functionality.
    - They allow anyone to read/write to the 'rooms' collection, which is necessary for multiplayer.
    - They ensure that only logged-in users can create a user document for themselves.
    - A user can only update their own document.
    - The 'variants' collection is read-only for all users, so they can't cheat and change upgrade prices.
      Only you (from the server/console) or an admin (if you build that rule) should write to it.
      For the admin panel to work, we are adding a rule that allows users with the 'admin' privilege to write to the variants collection.

    THE RULES HAVE BEEN PROVIDED IN A SEPARATE DOCUMENT. PLEASE COPY THEM INTO YOUR FIRESTORE RULES EDITOR.
    -->
    <style>
        :root {
            --bg-color: #2c2f33;
            --secondary-bg: #23272a;
            --primary-text: #ffffff;
            --accent-color: #7289da;
            --accent-hover: #677bc4;
            --danger-color: #f04747;
            --success-color: #43b581;
            --warning-color: #faa61a;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #app-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* --- AUTH & ROOMS --- */
        .screen {
            background-color: var(--secondary-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 400px;
            text-align: center;
        }
        .screen h1 { margin-top: 0; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold;}
        .form-group input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            background-color: var(--bg-color);
            border: 1px solid #444;
            border-radius: var(--border-radius);
            color: var(--primary-text);
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            border: none;
            border-radius: var(--border-radius);
            color: var(--primary-text);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { background-color: var(--accent-hover); }
        .toggle-link { margin-top: 20px; color: var(--accent-color); cursor: pointer; }
        .error-message { color: var(--danger-color); margin-top: 15px; min-height: 20px;}
        .divider {
            display: flex; align-items: center; text-align: center; margin: 20px 0;
        }
        .divider::before, .divider::after {
            content: ''; flex: 1; border-bottom: 1px solid #444;
        }
        .divider:not(:empty)::before { margin-right: .25em; }
        .divider:not(:empty)::after { margin-left: .25em; }

        /* --- GAME SCREEN --- */
        #game-screen {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        #game-canvas {
            background-color: #3a3f44;
            flex-grow: 1;
        }
        #hud {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: var(--secondary-bg);
            flex-wrap: wrap;
        }
        .stat { display: flex; align-items: center; font-size: 1.2em; }
        .stat span { margin-left: 8px; }
        #controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background-color: var(--secondary-bg);
        }
        #controls button { width: auto; padding: 10px 20px;}
        #admin-panel-btn { background-color: var(--warning-color); }
        #logout-btn { background-color: var(--danger-color); }
        #day-night-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000030;
            opacity: 0;
            pointer-events: none;
            transition: opacity 2s ease-in-out;
        }

        /* --- MODALS --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            width: 80%;
            max-width: 600px;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .shop-grid, .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .shop-item {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .shop-item img {
            width: 64px;
            height: 64px;
            object-fit: contain;
            margin: 0 auto 10px auto;
        }
        .shop-item button { width: 100%; font-size: 14px; padding: 8px;}

        /* --- GUBBY INFO --- */
        #gubby-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: var(--border-radius);
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="app-container">

        <!-- AUTHENTICATION & ROOM SELECTION SCREEN -->
        <div id="auth-container" class="screen">
            <!-- Login Form -->
            <div id="login-form">
                <h1>Welcome Back!</h1>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button id="login-btn">Login</button>
                <div class="error-message" id="login-error"></div>
                <p class="toggle-link" onclick="toggleAuthForms()">Need an account? Sign Up</p>
            </div>

            <!-- Signup Form -->
            <div id="signup-form" class="hidden">
                <h1>Create Account</h1>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" required>
                </div>
                <button id="signup-btn">Sign Up</button>
                <div class="error-message" id="signup-error"></div>
                <p class="toggle-link" onclick="toggleAuthForms()">Already have an account? Login</p>
            </div>
            
            <!-- Room Selection (shown after login) -->
            <div id="room-selection" class="hidden">
                <h1>Join a Room</h1>
                <div class="form-group">
                    <label for="room-code-input">Enter Room Code</label>
                    <input type="text" id="room-code-input" placeholder="e.g., ABCDE">
                </div>
                <button id="join-room-btn">Join Room</button>
                <div class="divider">OR</div>
                <button id="create-room-btn">Create a New Room</button>
                <div class="error-message" id="room-error"></div>
            </div>
        </div>

        <!-- MAIN GAME SCREEN -->
        <div id="game-screen" class="hidden">
            <div id="gubby-info">
                <h2 id="gubby-name-display">Gubby</h2>
                <p>Room Code: <b id="room-code-display"></b></p>
            </div>
            <div id="day-night-overlay"></div>
            <canvas id="game-canvas"></canvas>
            <div id="hud">
                <div class="stat">üí∞ <span id="money-stat">0</span></div>
                <div class="stat">üçî <span id="hunger-stat">100</span>%</div>
                <div class="stat">üíß <span id="thirst-stat">100</span>%</div>
                <div class="stat">‚ö° <span id="energy-stat">100</span>%</div>
            </div>
            <div id="controls">
                <button id="feed-btn">Feed (Cost: 10)</button>
                <button id="water-btn">Water (Cost: 5)</button>
                <button id="shop-btn">Shop</button>
                <button id="admin-panel-btn" class="hidden">Admin Panel</button>
                <button id="logout-btn">Logout</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="name-modal" class="modal">
        <div class="modal-content">
            <h2>Name Your Gubby!</h2>
            <div class="form-group">
                <label for="gubby-name-input">Gubby's Name</label>
                <input type="text" id="gubby-name-input" maxlength="20">
            </div>
            <button id="save-name-btn">Save Name</button>
        </div>
    </div>

    <div id="shop-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('shop-modal')">&times;</span>
            <h2>Shop</h2>
            <h3>Upgrades</h3>
            <div id="upgrades-grid" class="shop-grid">
                <!-- Upgrades will be populated by JS -->
            </div>
            <h3>Gubby Variants</h3>
            <div id="variants-grid" class="shop-grid">
                <!-- Variants will be populated by JS -->
            </div>
        </div>
    </div>
    
    <div id="admin-panel-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('admin-panel-modal')">&times;</span>
            <h2>Admin Panel: Add Gubby Variant</h2>
            <div class="form-group">
                <label for="variant-name">Variant Name (e.g., Water Gubby)</label>
                <input type="text" id="variant-name">
            </div>
            <div class="form-group">
                <label for="variant-filename">Sprite Filename (e.g., water.png)</label>
                <input type="text" id="variant-filename" placeholder="Must be in sprites/variants/">
            </div>
            <div class="form-group">
                <label for="variant-price">Price</label>
                <input type="number" id="variant-price" value="1000">
            </div>
            <div class="form-group">
                <label for="variant-multiplier">Click Multiplier</label>
                <input type="number" id="variant-multiplier" value="1.5" step="0.1">
            </div>
             <div class="form-group">
                <label for="variant-description">Description (e.g., Resists thirst)</label>
                <input type="text" id="variant-description">
            </div>
            <button id="add-variant-btn">Add Variant</button>
            <div class="error-message" id="admin-error"></div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, serverTimestamp, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // 1. --- YOUR FIREBASE CONFIGURATION ---
        // This has been updated with the config you provided.
        const firebaseConfig = {
            apiKey: "AIzaSyAai5V9VTtPnAdMoAhhVe94fobPOY25yf8",
            authDomain: "gubby-clicker.firebaseapp.com",
            projectId: "gubby-clicker",
            storageBucket: "gubby-clicker.appspot.com",
            messagingSenderId: "255072290621",
            appId: "1:255072290621:web:9f80676beac50c0059a754",
            measurementId: "G-R3HFMPH5C4"
        };

        // 2. --- INITIALIZE FIREBASE & GET SERVICES ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 3. --- DOM ELEMENT REFERENCES ---
        const authContainer = document.getElementById('auth-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const roomSelection = document.getElementById('room-selection');
        const gameScreen = document.getElementById('game-screen');
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // Buttons
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const shopBtn = document.getElementById('shop-btn');
        const adminBtn = document.getElementById('admin-panel-btn');
        const addVariantBtn = document.getElementById('add-variant-btn');

        // Stats
        const moneyStat = document.getElementById('money-stat');
        const hungerStat = document.getElementById('hunger-stat');
        const thirstStat = document.getElementById('thirst-stat');
        const energyStat = document.getElementById('energy-stat');
        const gubbyNameDisplay = document.getElementById('gubby-name-display');
        const roomCodeDisplay = document.getElementById('room-code-display');
        
        // Modals
        const nameModal = document.getElementById('name-modal');
        const shopModal = document.getElementById('shop-modal');
        const adminModal = document.getElementById('admin-panel-modal');

        // 4. --- GAME STATE & CONSTANTS ---
        let currentUser = null;
        let currentRoomId = null;
        let unsubscribeFromRoom = null; // To stop listening to room updates on logout
        let gubby = {
            x: 100, y: 100,
            width: 128, height: 128,
            vx: 1, vy: 1,
            img: new Image(),
            isSleeping: false,
            isDead: false
        };
        gubby.img.src = 'sprites/variants/default.png'; // Default sprite

        const GAME_TICK_RATE = 2000; // Deplete stats every 2 seconds
        const DAY_NIGHT_DURATION = 60000; // 1 minute day, 1 minute night
        let lastTickTime = 0;
        let timeOfDay = 0; // 0 to DAY_NIGHT_DURATION*2
        let isDay = true;
        let gameLoopId = null; // To store the requestAnimationFrame ID

        // --- HELPER FUNCTIONS ---
        window.toggleAuthForms = function() {
            loginForm.classList.toggle('hidden');
            signupForm.classList.toggle('hidden');
        }
        window.openModal = function(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        window.closeModal = function(modalId) { document.getElementById(modalId).style.display = 'none'; }
        
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 7).toUpperCase();
        }

        // 5. --- AUTHENTICATION LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                roomSelection.classList.remove('hidden');
                gameScreen.classList.add('hidden'); // Hide game until room is joined
                
                await checkAdminStatus(user.uid);
            } else {
                currentUser = null;
                authContainer.classList.remove('hidden');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                roomSelection.classList.add('hidden');
                gameScreen.classList.add('hidden');
                if (unsubscribeFromRoom) unsubscribeFromRoom();
                if(gameLoopId) cancelAnimationFrame(gameLoopId);
            }
        });

        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(err => document.getElementById('login-error').textContent = err.message);
        });

        signupBtn.addEventListener('click', () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .then(userCredential => {
                    const userDocRef = doc(db, "users", userCredential.user.uid);
                    return setDoc(userDocRef, {
                        email: userCredential.user.email,
                        privileges: 'normal',
                        createdAt: serverTimestamp()
                    });
                })
                .catch(err => document.getElementById('signup-error').textContent = err.message);
        });
        
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        async function checkAdminStatus(uid) {
            const userDocRef = doc(db, "users", uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists() && userDoc.data().privileges === 'admin') {
                adminBtn.classList.remove('hidden');
            } else {
                adminBtn.classList.add('hidden');
            }
        }

        // 6. --- ROOM MANAGEMENT ---
        createRoomBtn.addEventListener('click', async () => {
            const roomId = generateRoomCode();
            const roomRef = doc(db, 'rooms', roomId);
            const defaultRoomState = {
                ownerId: currentUser.uid,
                money: 0,
                gubbyName: 'Gubby',
                hunger: 100,
                thirst: 100,
                energy: 100,
                currentVariant: 'default.png',
                upgrades: {
                    clickMultiplier: 1,
                },
                lastTick: serverTimestamp(),
                createdAt: serverTimestamp()
            };
            await setDoc(roomRef, defaultRoomState);
            joinRoom(roomId);
        });

        joinRoomBtn.addEventListener('click', () => {
            const roomId = document.getElementById('room-code-input').value.toUpperCase();
            if(roomId) joinRoom(roomId);
        });

        async function joinRoom(roomId) {
            const roomRef = doc(db, 'rooms', roomId);
            const roomDoc = await getDoc(roomRef);

            if (roomDoc.exists()) {
                currentRoomId = roomId;
                roomSelection.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                roomCodeDisplay.textContent = roomId;
                
                if (roomDoc.data().gubbyName === 'Gubby') {
                    openModal('name-modal');
                }

                listenToRoomUpdates(roomId);
                startGameLoop();
            } else {
                document.getElementById('room-error').textContent = "Room not found.";
            }
        }
        
        document.getElementById('save-name-btn').addEventListener('click', () => {
            const newName = document.getElementById('gubby-name-input').value;
            if (newName && currentRoomId) {
                const roomRef = doc(db, 'rooms', currentRoomId);
                updateDoc(roomRef, { gubbyName: newName });
                closeModal('name-modal');
            }
        });

        // 7. --- REALTIME DATABASE LISTENER ---
        function listenToRoomUpdates(roomId) {
            const roomRef = doc(db, 'rooms', roomId);
            if (unsubscribeFromRoom) unsubscribeFromRoom();

            unsubscribeFromRoom = onSnapshot(roomRef, (doc) => {
                const data = doc.data();
                if (!data) return;

                moneyStat.textContent = data.money;
                hungerStat.textContent = Math.round(data.hunger);
                thirstStat.textContent = Math.round(data.thirst);
                energyStat.textContent = Math.round(data.energy);
                gubbyNameDisplay.textContent = data.gubbyName;
                
                gubby.isDead = data.hunger <= 0 || data.thirst <= 0;
                gubby.img.src = gubby.isDead ? 'sprites/dead.png' : `sprites/variants/${data.currentVariant}`;
            });
        }
        
        function updateFirestoreState(field, value) {
            if (!currentRoomId) return;
            const roomRef = doc(db, 'rooms', currentRoomId);
            updateDoc(roomRef, { [field]: value })
                .catch(err => console.error("Error updating state:", err));
        }
        
        function incrementFirestoreState(field, amount) {
             if (!currentRoomId) return;
            const roomRef = doc(db, 'rooms', currentRoomId);
            updateDoc(roomRef, { [field]: increment(amount) })
                .catch(err => console.error("Error incrementing state:", err));
        }

        // 8. --- CANVAS & GAME LOOP ---
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }

        function startGameLoop() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            lastTickTime = performance.now();
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function gameLoop(timestamp) {
            if (!currentRoomId) return;

            const deltaTime = timestamp - lastTickTime;
            lastTickTime = timestamp;

            updateGameLogic(deltaTime);
            updateGubbyMovement();
            render();

            gameLoopId = requestAnimationFrame(gameLoop);
        }
        
        async function updateGameLogic(deltaTime) {
            timeOfDay = (timeOfDay + deltaTime) % (DAY_NIGHT_DURATION * 2);
            const wasDay = isDay;
            isDay = timeOfDay < DAY_NIGHT_DURATION;
            
            if(wasDay !== isDay) {
                gubby.isSleeping = !isDay;
                document.getElementById('day-night-overlay').style.opacity = isDay ? '0' : '0.4';
            }
            
            // This logic should ideally be a cloud function to prevent multiple clients from running it.
            // For simplicity, we'll run it here. Only the room owner will try to update.
            const roomRef = doc(db, 'rooms', currentRoomId);
            const roomDoc = await getDoc(roomRef);
            const data = roomDoc.data();

            if (data.ownerId === currentUser.uid) {
                const now = Date.now();
                const lastTick = data.lastTick.toDate().getTime();
                const ticksPassed = Math.floor((now - lastTick) / GAME_TICK_RATE);

                if (ticksPassed > 0) {
                    if (!gubby.isDead) {
                        const hungerLoss = ticksPassed * 1;
                        const thirstLoss = ticksPassed * 1.5;
                        const energyChange = gubby.isSleeping ? ticksPassed * 2 : ticksPassed * -0.5;
                        
                        updateDoc(roomRef, {
                            hunger: increment(-hungerLoss),
                            thirst: increment(-thirstLoss),
                            energy: increment(energyChange),
                            lastTick: serverTimestamp()
                        });
                    }
                }
            }
        }
        
        function updateGubbyMovement() {
            if (gubby.isDead || gubby.isSleeping) return;

            gubby.x += gubby.vx;
            gubby.y += gubby.vy;

            if (gubby.x <= 0 || gubby.x + gubby.width >= canvas.width) gubby.vx *= -1;
            if (gubby.y <= 0 || gubby.y + gubby.height >= canvas.height) gubby.vy *= -1;
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#8c6d52';
            ctx.fillRect(0, canvas.height - 20, canvas.width, 20);

            ctx.drawImage(gubby.img, gubby.x, gubby.y, gubby.width, gubby.height);
        }

        // 9. --- GAME ACTIONS & CONTROLS ---
        canvas.addEventListener('click', async (event) => {
            if (gubby.isDead || gubby.isSleeping) return;

            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            if (x >= gubby.x && x <= gubby.x + gubby.width &&
                y >= gubby.y && y <= gubby.y + gubby.height) {
                const roomRef = doc(db, 'rooms', currentRoomId);
                const roomDoc = await getDoc(roomRef);
                const clickPower = roomDoc.data().upgrades.clickMultiplier || 1;
                incrementFirestoreState('money', clickPower);
            }
        });
        
        document.getElementById('feed-btn').addEventListener('click', () => {
             incrementFirestoreState('money', -10);
             incrementFirestoreState('hunger', 20);
             incrementFirestoreState('energy', 5);
        });

        document.getElementById('water-btn').addEventListener('click', () => {
             incrementFirestoreState('money', -5);
             incrementFirestoreState('thirst', 25);
        });
        
        // 10. --- SHOP & ADMIN LOGIC ---
        shopBtn.addEventListener('click', async () => {
            const variantsCollectionRef = collection(db, 'variants');
            const snapshot = await getDocs(variantsCollectionRef);
            const variantsGrid = document.getElementById('variants-grid');
            variantsGrid.innerHTML = '';
            
            snapshot.forEach(doc => {
                const variant = doc.data();
                const item = document.createElement('div');
                item.className = 'shop-item';
                item.innerHTML = `
                    <img src="sprites/variants/${variant.filename}" alt="${variant.name}">
                    <h4>${variant.name}</h4>
                    <p>${variant.description}</p>
                    <p>Multiplier: x${variant.multiplier}</p>
                    <button onclick="buyVariant('${doc.id}', ${variant.price})">Buy (üí∞${variant.price})</button>
                `;
                variantsGrid.appendChild(item);
            });
            
            openModal('shop-modal');
        });
        
        window.buyVariant = async function(variantId, price) {
            const roomRef = doc(db, 'rooms', currentRoomId);
            const roomDoc = await getDoc(roomRef);
            if (roomDoc.data().money >= price) {
                const variantRef = doc(db, 'variants', variantId);
                const variantDoc = await getDoc(variantRef);
                const variantData = variantDoc.data();
                
                updateDoc(roomRef, {
                    money: increment(-price),
                    currentVariant: variantData.filename,
                    'upgrades.clickMultiplier': variantData.multiplier
                });

                alert(`You bought ${variantData.name}!`);
                closeModal('shop-modal');
            } else {
                alert("Not enough money!");
            }
        }
        
        adminBtn.addEventListener('click', () => openModal('admin-panel-modal'));
        
        addVariantBtn.addEventListener('click', async () => {
            const name = document.getElementById('variant-name').value;
            const filename = document.getElementById('variant-filename').value;
            const price = parseInt(document.getElementById('variant-price').value);
            const multiplier = parseFloat(document.getElementById('variant-multiplier').value);
            const description = document.getElementById('variant-description').value;
            
            if(!name || !filename || !price || !multiplier) {
                document.getElementById('admin-error').textContent = "All fields are required.";
                return;
            }
            
            try {
                const newVariantRef = doc(collection(db, 'variants'));
                await setDoc(newVariantRef, {
                    name, filename, price, multiplier, description
                });
                alert('Variant added successfully!');
                closeModal('admin-panel-modal');
            } catch(err) {
                console.error("Admin error:", err);
                document.getElementById('admin-error').textContent = "You do not have permission or an error occurred.";
            }
        });

    </script>
</body>
</html>
